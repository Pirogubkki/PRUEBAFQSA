<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Horarios Facultad</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-green: #2d5a3d;
      --light-green: #8cc38a;
      --accent-green: #a8d4a6;
      --pink-accent: #f05aaa;
      --light-pink: rgba(240, 90, 170, 0.1);
      --background: #fafbfc;
      --card-bg: #ffffff;
      --text-primary: #1a1a1a;
      --text-secondary: #6b7280;
      --border-light: #e5e7eb;
      --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-medium: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --shadow-large: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: "Inter", sans-serif;
      background: linear-gradient(135deg, #f8fffe 0%, #f0f9f0 100%);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Header con gradiente elegante */
    .main-header {
      background: linear-gradient(135deg, var(--primary-green) 0%, var(--light-green) 100%);
      color: white;
      padding: 3rem 2rem 2rem;
      text-align: center;
      position: relative;
      overflow: hidden;
      box-shadow: var(--shadow-medium);
    }

    .main-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.05"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.05"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.03"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>') repeat;
      opacity: 0.3;
    }

    .main-header h1 {
      font-size: clamp(2rem, 5vw, 3.5rem);
      font-weight: 700;
      margin-bottom: 0.5rem;
      position: relative;
      z-index: 1;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .main-header h5 {
      font-size: 1.1rem;
      font-weight: 400;
      opacity: 0.9;
      position: relative;
      z-index: 1;
    }

    /* Bot√≥n de solicitud flotante */
    .open-modal-btn {
      position: fixed;
      top: 2rem;
      right: 2rem;
      background: linear-gradient(135deg, var(--light-green) 0%, var(--accent-green) 100%);
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 50px;
      border: none;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      box-shadow: var(--shadow-medium);
      transition: all 0.3s ease;
      z-index: 100;
      backdrop-filter: blur(10px);
    }

    .open-modal-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-large);
      background: linear-gradient(135deg, var(--accent-green) 0%, var(--light-green) 100%);
    }

    /* Container principal */
    .main-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 2rem;
      display: grid;
      gap: 2rem;
      grid-template-columns: 1fr;
    }

    @media (min-width: 1024px) {
      .main-container {
        grid-template-columns: 350px 1fr;
      }
    }

    /* Sidebar */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 2rem;
    }

    /* Buscador elegante */
    .buscador-libres {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-light);
    }

    .buscador-libres h2 {
      color: var(--primary-green);
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .buscador-libres h2::before {
      content: "üîç";
      font-size: 1.2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      color: var(--text-primary);
      font-weight: 500;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }

    .form-group select,
    .form-group input {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 2px solid var(--border-light);
      border-radius: 12px;
      font-size: 0.95rem;
      transition: all 0.2s ease;
      background: white;
    }

    .form-group select:focus,
    .form-group input:focus {
      outline: none;
      border-color: var(--light-green);
      box-shadow: 0 0 0 3px rgba(140, 195, 138, 0.1);
    }

    #buscador-btn {
      width: 100%;
      background: linear-gradient(135deg, var(--primary-green) 0%, var(--light-green) 100%);
      color: white;
      padding: 0.875rem 1.5rem;
      border: none;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-soft);
    }

    #buscador-btn:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-medium);
    }

    #resultado-buscador {
      margin-top: 1rem;
      padding: 1rem;
      background: linear-gradient(135deg, #f0f9f0 0%, #e8f5e8 100%);
      border-radius: 12px;
      border-left: 4px solid var(--light-green);
      font-weight: 500;
      color: var(--primary-green);
    }

    /* Recuadro de avisos */
    .avisos-container {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-light);
    }

    .avisos-container h2 {
      color: var(--primary-green);
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .avisos-container h2::before {
      content: "üì¢";
      font-size: 1.2rem;
    }

    .aviso-item {
      background: linear-gradient(135deg, rgba(240, 90, 170, 0.05) 0%, rgba(240, 90, 170, 0.02) 100%);
      border: 1px solid rgba(240, 90, 170, 0.2);
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      position: relative;
      overflow: hidden;
    }

    .aviso-item:last-child {
      margin-bottom: 0;
    }

    .aviso-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: linear-gradient(180deg, var(--pink-accent) 0%, var(--light-green) 100%);
    }

    .aviso-fecha {
      font-size: 0.8rem;
      color: var(--text-secondary);
      font-weight: 500;
      margin-bottom: 0.5rem;
    }

    .aviso-texto {
      color: var(--text-primary);
      font-size: 0.9rem;
      line-height: 1.5;
    }

    /* √Årea principal */
    .main-content {
      background: var(--card-bg);
      border-radius: 20px;
      padding: 2rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-light);
    }

    /* Leyenda mejorada */
    .leyenda {
      display: flex;
      gap: 2rem;
      align-items: center;
      margin-bottom: 2rem;
      padding: 1rem;
      background: linear-gradient(135deg, #f8fffe 0%, #f0f9f0 100%);
      border-radius: 15px;
      border: 1px solid var(--border-light);
    }

    .leyenda-item {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-weight: 500;
      color: var(--text-primary);
    }

    .cuadro {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      box-shadow: var(--shadow-soft);
      border: 2px solid transparent;
    }

    .cuadro.verde {
      background: linear-gradient(135deg, rgba(140, 195, 138, 0.8) 0%, rgba(168, 212, 166, 0.8) 100%);
      border-color: var(--light-green);
    }

    .cuadro.rosa {
      background: linear-gradient(135deg, rgba(240, 90, 170, 0.8) 0%, rgba(240, 120, 180, 0.8) 100%);
      border-color: var(--pink-accent);
    }

    /* Botones de salones */
    .submenu-salones, #button-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-bottom: 2rem;
    }

    .submenu-salones button,
    #button-bar button {
      padding: 0.75rem 1.25rem;
      border-radius: 25px;
      border: 2px solid var(--border-light);
      background: white;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-soft);
    }

    .submenu-salones button:hover,
    #button-bar button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-medium);
      border-color: var(--light-green);
      background: linear-gradient(135deg, #f8fffe 0%, #f0f9f0 100%);
    }

    .submenu-salones button.active,
    #button-bar button.active {
      background: linear-gradient(135deg, var(--primary-green) 0%, var(--light-green) 100%);
      color: white;
      border-color: var(--light-green);
      box-shadow: var(--shadow-medium);
    }

    /* Grid de horarios mejorado */
    .horario-container h2 {
      color: var(--primary-green);
      font-size: 1.8rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }

    .horario-grid {
      display: grid;
      grid-template-columns: 120px repeat(5, 1fr);
      grid-template-rows: auto repeat(24, 45px);
      gap: 1px;
      background: var(--border-light);
      border-radius: 15px;
      overflow: hidden;
      box-shadow: var(--shadow-medium);
      margin: 1.5rem 0;
    }

    .grid-header {
      background: linear-gradient(135deg, var(--primary-green) 0%, var(--light-green) 100%);
      color: white;
      padding: 1rem;
      font-weight: 600;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.95rem;
    }

    .grid-hora {
      background: linear-gradient(135deg, #f8fffe 0%, #f0f9f0 100%);
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 0.8rem;
      padding: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      border-right: 2px solid var(--border-light);
    }

    .grid-clase {
      margin: 2px;
      border-radius: 8px;
      padding: 0.5rem;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .grid-clase.semestral {
      background: linear-gradient(135deg, rgba(140, 195, 138, 0.2) 0%, rgba(168, 212, 166, 0.3) 100%);
      border: 2px solid var(--light-green);
      color: var(--primary-green);
    }

    .grid-clase.extraordinaria {
      background: linear-gradient(135deg, rgba(240, 90, 170, 0.15) 0%, rgba(240, 120, 180, 0.25) 100%);
      border: 2px solid var(--pink-accent);
      color: #7c325e;
    }

    .grid-clase:hover {
      transform: scale(1.02);
      box-shadow: var(--shadow-medium);
    }

    .materia-nombre {
      font-size: 0.85rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      line-height: 1.2;
    }

    .materia-horario {
      font-size: 0.75rem;
      font-weight: 500;
      opacity: 0.8;
    }

    /* Modal mejorado */
    .modal-bg {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(8px);
      z-index: 1000;
      display: none;
      justify-content: center;
      align-items: center;
      padding: 1rem;
    }

    .modal-bg.active {
      display: flex;
    }

    .modal-solicitud {
      background: white;
      border-radius: 20px;
      box-shadow: var(--shadow-large);
      padding: 2.5rem;
      max-width: 400px;
      width: 100%;
      position: relative;
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-solicitud h2 {
      color: var(--primary-green);
      font-size: 1.5rem;
      font-weight: 600;
      text-align: center;
      margin-bottom: 2rem;
    }

    .modal-solicitud .form-group {
      margin-bottom: 1.5rem;
    }

    .modal-solicitud button[type="submit"] {
      width: 100%;
      background: linear-gradient(135deg, var(--primary-green) 0%, var(--light-green) 100%);
      color: white;
      padding: 1rem;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: var(--shadow-soft);
    }

    .modal-solicitud button[type="submit"]:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-medium);
    }

    .close-modal-btn {
      position: absolute;
      right: 1rem;
      top: 1rem;
      font-size: 1.5rem;
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    .close-modal-btn:hover {
      background: rgba(0, 0, 0, 0.1);
      color: var(--primary-green);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .main-container {
        padding: 1rem;
        gap: 1.5rem;
      }

      .open-modal-btn {
        position: relative;
        top: auto;
        right: auto;
        margin: 1rem auto;
        display: block;
        width: fit-content;
      }

      .horario-grid {
        grid-template-columns: 80px repeat(5, 1fr);
        grid-template-rows: auto repeat(24, 40px);
      }

      .grid-header {
        padding: 0.5rem 0.25rem;
        font-size: 0.8rem;
      }

      .grid-hora {
        font-size: 0.7rem;
        padding: 0.25rem;
      }

      .materia-nombre {
        font-size: 0.75rem;
      }

      .materia-horario {
        font-size: 0.65rem;
      }
    }
  </style>
</head>
<body>
  <header class="main-header">
    <h1>Horarios de los salones agosto-diciembre 2025</h1>
    <h5>Contacto: Instagram <b>@Poolkiin</b></h5>
  </header>

  <button class="open-modal-btn" onclick="openSolicitud()">üìÖ Solicitar espacio</button>

  <div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
      <!-- Buscador -->
      <div class="buscador-libres">
        <h2>Buscar espacio libre</h2>
        <div class="form-group">
          <label for="busc-dia">D√≠a:</label>
          <select id="busc-dia">
            <option>Lunes</option>
            <option>Martes</option>
            <option>Mi√©rcoles</option>
            <option>Jueves</option>
            <option>Viernes</option>
          </select>
        </div>
        <div class="form-group">
          <label for="busc-hora">Hora de inicio:</label>
          <input type="time" id="busc-hora" min="08:00" max="20:00" step="1800" value="08:00" />
        </div>
        <div class="form-group">
          <label for="busc-duracion">Duraci√≥n (min):</label>
          <select id="busc-duracion">
            <option value="30">30</option>
            <option value="60" selected>60</option>
            <option value="90">90</option>
            <option value="120">120</option>
          </select>
        </div>
        <button id="buscador-btn">üîç Buscar</button>
        <div id="resultado-buscador"></div>
      </div>

      <!-- Avisos y reportes -->
      <div class="avisos-container">
        <h2>Avisos y reportes</h2>
        <div class="aviso-item">
          <div class="aviso-fecha">15 Sep 2025</div>
          <div class="aviso-texto">
            <strong>Mantenimiento programado:</strong> El laboratorio 3 estar√° cerrado por mantenimiento el viernes de 2:00-4:00 PM.
          </div>
        </div>
        <div class="aviso-item">
          <div class="aviso-fecha">12 Sep 2025</div>
          <div class="aviso-texto">
            <strong>Nuevo equipo:</strong> Se instal√≥ nuevo equipo de proyecci√≥n en el Sal√≥n de Usos M√∫ltiples.
          </div>
        </div>
        <div class="aviso-item">
          <div class="aviso-fecha">10 Sep 2025</div>
          <div class="aviso-texto">
            <strong>Recordatorio:</strong> Favor de reportar cualquier problema con el mobiliario o equipo a trav√©s del formulario de solicitud.
          </div>
        </div>
        <div style="text-align: center; margin-top: 1rem;">
          <small style="color: var(--text-secondary); font-style: italic;">
            ¬øTienes un reporte? Usa el bot√≥n "Solicitar espacio" para enviarlo.
          </small>
        </div>
      </div>
    </div>

    <!-- Contenido principal -->
    <div class="main-content">
      <div class="leyenda">
        <div class="leyenda-item">
          <span class="cuadro verde"></span>
          <span>Clase semestral</span>
        </div>
        <div class="leyenda-item">
          <span class="cuadro rosa"></span>
          <span>Clase extraordinaria</span>
        </div>
      </div>

      <div id="salones" class="tab-content active">
        <div class="submenu-salones" id="button-bar"></div>
        <div id="horario-espacio"></div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="modal-solicitud-bg" class="modal-bg">
    <div class="modal-solicitud">
      <button class="close-modal-btn" onclick="closeSolicitud()">√ó</button>
      <h2>Apartar un sal√≥n</h2>
      <form id="my-form" action="https://api.sheetmonkey.io/form/wci2QVScCM6NKECY2PfGBB" method="post">
        <div class="form-group">
          <label>Email:</label>
          <input type="email" name="email" required />
        </div>
        <div class="form-group">
          <label>Sal√≥n, Horario, D√≠a y ¬øhasta qu√© fecha estar√° apartado el sitio?:</label>
          <input type="text" name="message" required />
        </div>
        <input type="hidden" name="Created" value="x-sheetmonkey-current-date-time" />
        <button type="submit">üì§ Enviar solicitud</button>
        <p id="my-form-status"></p>
      </form>
    </div>
  </div>

  <script>
    const dias = ["Lunes", "Martes", "Miercoles", "Jueves", "Viernes"];
    const horaInicio = 8, horaFin = 20;

    // Orden personalizado para los botones
    const ordenSalones = [
      "Salon 1", "Salon 2", "Salon 3", "Salon 4", "Salon 5", "Salon 6", "Salon 7", "Salon 8", "Salon 9", "Salon 10", "Salon 11", "Salon 12",
      "Laboratorio 1", "Laboratorio 2", "Laboratorio 3", "Laboratorio 4",
      "Salon De Usos Multiples"
    ];

    // Generar intervalos de 30 minutos
    const intervalos = [];
    for (let h = horaInicio; h < horaFin; h++) {
      intervalos.push({inicio:`${String(h).padStart(2,'0')}:00`, fin:`${String(h).padStart(2,'0')}:30`});
      intervalos.push({inicio:`${String(h).padStart(2,'0')}:30`, fin:`${String(h+1).padStart(2,'0')}:00`});
    }

    let horariosJSON = {};
    let activeButton = null;

    // URL de tu hoja p√∫blica
    const SHEET_URL = "https://opensheet.elk.sh/1fDuIQUaqOSTsXPbwBrB7s5V7yfZZGfF0jUXcVS_WIJs/2";

    // Funciones utilitarias (mantienen la misma l√≥gica)
    function normalizaDia(str) {
      if (!str) return "";
      str = str.toLowerCase()
        .replace(/[√°√†]/g,'a')
        .replace(/[√©√®]/g,'e')
        .replace(/[√≠√¨]/g,'i')
        .replace(/[√≥√≤]/g,'o')
        .replace(/[√∫√π]/g,'u');
      return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function normalizaSalon(str) {
      if (!str) return "";
      return str.normalize('NFD').replace(/[\u0300-\u036f]/g, "").replace(/\b([a-z])/g, l => l.toUpperCase());
    }

    function normalizaHora(horaStr) {
      if (!horaStr) return "";
      horaStr = horaStr.trim();
      const parts = horaStr.split(':');
      if (parts[0].length === 1) {
        parts[0] = '0' + parts[0];
      }
      return parts.join(':');
    }

    function normalizaNombre(str) {
      return str.normalize('NFD').replace(/[\u0300-\u036f]/g, "").toLowerCase();
    }

    function calcularDuracionEnIntervalos(inicio, fin) {
      let inicioIdx = -1;
      let finIdx = -1;
      
      // Buscar √≠ndice de inicio
      for (let i = 0; i < intervalos.length; i++) {
        if (intervalos[i].inicio === inicio) {
          inicioIdx = i;
          break;
        }
      }
      
      // Buscar √≠ndice de fin - corregido para buscar por hora de fin, no por intervalo
      for (let i = 0; i < intervalos.length; i++) {
        if (intervalos[i].fin === fin) {
          finIdx = i;
          break;
        }
      }
      
      // Si no encontramos el fin exacto, buscar el intervalo que contiene esa hora como inicio
      // Esto maneja casos como 20:00 que no est√° en nuestros intervalos como fin
      if (finIdx === -1) {
        for (let i = 0; i < intervalos.length; i++) {
          if (intervalos[i].inicio === fin) {
            finIdx = i - 1; // El intervalo anterior es donde termina realmente
            break;
          }
        }
      }
      
      if (inicioIdx === -1) {
        console.warn(`No se encontr√≥ intervalo de inicio para: ${inicio}`);
        return 1;
      }
      
      if (finIdx === -1) {
        console.warn(`No se encontr√≥ intervalo de fin para: ${fin}`);
        // Si es 20:00, deber√≠a ser el √∫ltimo intervalo (19:30-20:00)
        if (fin === "20:00") {
          finIdx = intervalos.length - 1;
        } else {
          return 1;
        }
      }
      
      const duracion = finIdx - inicioIdx + 1;
      console.log(`Duraci√≥n calculada para ${inicio} - ${fin}: ${duracion} intervalos (√≠ndices ${inicioIdx} a ${finIdx})`);
      return duracion;
    }

    function agrupaHorariosPorSalon(rows) {
      const resultado = {};
      rows.forEach(row => {
        const salon = normalizaSalon((row["Salon"] || row["Sal√≥n"] || row["salon"] || "").trim());
        const dia = normalizaDia((row["Dia"] || row["d√≠a"] || row["dia"] || "").trim());
        if (!salon || !dia) return;
        
        if (!resultado[salon]) {
          resultado[salon] = {capacidad: row["capacidad"] ? Number(row["capacidad"]) : undefined};
          dias.forEach(d => resultado[salon][d] = []);
        }
        
        if (dias.includes(dia)) {
          const inicio = normalizaHora((row["Inicio"] || row["inicio"] || "").trim());
          const fin = normalizaHora((row["Fin"] || row["fin"] || "").trim());
          
          if (inicio && fin) {
            resultado[salon][dia].push({
              materia: (row["Materia"] || row["materia"] || "").trim(),
              inicio: inicio,
              fin: fin,
              tipo: (row["tipo"] || "").trim(),
              comentario: (row["comentario"] || "").trim()
            });
          }
        }
      });
      return resultado;
    }

    function renderAllButtons(horarios) {
      const bar = document.getElementById('button-bar');
      bar.innerHTML = "";

      const mapaNombreReal = {};
      Object.keys(horarios).forEach(n => {
        mapaNombreReal[normalizaNombre(n)] = n;
      });

      // Primero en el orden deseado
      ordenSalones.forEach(n => {
        const nNorm = normalizaNombre(n);
        if (mapaNombreReal[nNorm]) {
          const btn = document.createElement('button');
          btn.textContent = mapaNombreReal[nNorm];
          btn.onclick = () => showSchedule(mapaNombreReal[nNorm], btn);
          bar.appendChild(btn);
        }
      });

      // Luego, los que no est√°n en el orden personalizado
      Object.keys(horarios).forEach(n => {
        if (!ordenSalones.map(normalizaNombre).includes(normalizaNombre(n))) {
          const btn = document.createElement('button');
          btn.textContent = n;
          btn.onclick = () => showSchedule(n, btn);
          bar.appendChild(btn);
        }
      });
    }

    function convertirADatosEventos(nombre, horariosSalon) {
      const eventos = [];
      dias.forEach(dia => {
        if (horariosSalon[dia]) {
          horariosSalon[dia].forEach(clase => {
            eventos.push({
              dia: dia,
              inicio: clase.inicio,
              fin: clase.fin,
              materia: clase.materia,
              tipo: clase.tipo,
              comentario: clase.comentario
            });
          });
        }
      });
      return eventos;
    }

    function renderCalendario(id, data, nombre) {
      const cont = document.getElementById(id);
      cont.innerHTML = "";
      cont.className = "horario-container";

      // T√≠tulo y capacidad
      const tit = document.createElement("h2");
      tit.textContent = nombre;
      cont.appendChild(tit);
      
      if (horariosJSON[nombre] && horariosJSON[nombre].capacidad) {
        const capacidadDiv = document.createElement("div");
        capacidadDiv.style.cssText = "font-size:15px; color:#388; margin-bottom: 10px; font-weight: 500;";
        capacidadDiv.innerHTML = `üìç Capacidad: <strong>${horariosJSON[nombre].capacidad} alumnos</strong>`;
        cont.appendChild(capacidadDiv);
      }

      // Crear contenedor grid
      const gridContainer = document.createElement("div");
      gridContainer.className = "horario-grid";
      cont.appendChild(gridContainer);

      // Header - celda vac√≠a para la esquina
      const cornerCell = document.createElement("div");
      cornerCell.className = "grid-header";
      cornerCell.textContent = "Hora";
      gridContainer.appendChild(cornerCell);

      // Headers de d√≠as
      dias.forEach(dia => {
        const headerCell = document.createElement("div");
        headerCell.className = "grid-header";
        headerCell.textContent = dia;
        gridContainer.appendChild(headerCell);
      });

      // Crear un mapa para rastrear qu√© celdas est√°n ocupadas
      const celdasOcupadas = new Set();

      // Para cada intervalo de tiempo
      intervalos.forEach((intervalo, filaIdx) => {
        // Celda de hora
        const horaCell = document.createElement("div");
        horaCell.className = "grid-hora";
        horaCell.textContent = `${intervalo.inicio} - ${intervalo.fin}`;
        horaCell.style.cssText = `
          grid-row: ${filaIdx + 2};
          grid-column: 1;
        `;
        gridContainer.appendChild(horaCell);

        // Para cada d√≠a
        dias.forEach((dia, diaIdx) => {
          const celdaKey = `${filaIdx}-${diaIdx}`;
          
          // Solo procesar si la celda no est√° ocupada
          if (!celdasOcupadas.has(celdaKey)) {
            // Buscar si hay una clase que comience exactamente en este intervalo y d√≠a
            const clase = data.find(ev => 
              ev.dia === dia && ev.inicio === intervalo.inicio
            );

            if (clase) {
              // Calcular duraci√≥n
              const duracion = calcularDuracionEnIntervalos(clase.inicio, clase.fin);
              
              // Marcar todas las celdas ocupadas por esta clase
              for (let i = 0; i < duracion; i++) {
                celdasOcupadas.add(`${filaIdx + i}-${diaIdx}`);
              }
              
              // Crear celda de clase
              const claseCell = document.createElement("div");
              
              // Determinar clase CSS
              let claseCSS = "grid-clase";
              if (clase.tipo === "extraordinaria") {
                claseCSS += " extraordinaria";
              } else {
                claseCSS += " semestral";
              }
              claseCell.className = claseCSS;
              
              // Posicionar en el grid
              claseCell.style.cssText = `
                grid-row: ${filaIdx + 2} / span ${duracion};
                grid-column: ${diaIdx + 2};
              `;
              
              // Contenido
              const materiaDiv = document.createElement("div");
              materiaDiv.className = "materia-nombre";
              materiaDiv.textContent = clase.materia;
              claseCell.appendChild(materiaDiv);
              
              const horarioDiv = document.createElement("div");
              horarioDiv.className = "materia-horario";
              horarioDiv.textContent = `${clase.inicio} - ${clase.fin}`;
              claseCell.appendChild(horarioDiv);
              
              if (clase.comentario) {
                const comentarioDiv = document.createElement("div");
                comentarioDiv.className = "materia-comentario";
                comentarioDiv.textContent = clase.comentario;
                comentarioDiv.style.cssText = `
                  font-size: 0.7rem;
                  font-style: italic;
                  opacity: 0.7;
                  margin-top: 0.25rem;
                  line-height: 1.1;
                `;
                claseCell.appendChild(comentarioDiv);
                claseCell.title = clase.comentario;
              }
              
              gridContainer.appendChild(claseCell);
            } else {
              // Crear celda vac√≠a
              const celdaVacia = document.createElement("div");
              celdaVacia.style.cssText = `
                grid-row: ${filaIdx + 2};
                grid-column: ${diaIdx + 2};
                background: white;
                border: 1px solid var(--border-light);
              `;
              gridContainer.appendChild(celdaVacia);
            }
          }
        });
      });
    }

    function showSchedule(nombre, btn) {
      if (activeButton) activeButton.classList.remove('active');
      btn.classList.add('active');
      activeButton = btn;
      
      const eventos = convertirADatosEventos(nombre, horariosJSON[nombre]);
      renderCalendario('horario-espacio', eventos, nombre);
    }

    // Funci√≥n para buscar espacios libres
    function buscarEspaciosLibres(dia, horaInicio, duracionMin) {
      const [h, m] = horaInicio.split(':').map(Number);
      if (
        isNaN(h) || isNaN(m) || 
        h < 8 || h >= 20 || 
        m < 0 || m > 59
      ) {
        return [];
      }

      const libres = [];
      const iniMin = h * 60 + m;
      const finMin = iniMin + duracionMin;

      Object.keys(horariosJSON).forEach(salon => {
        const eventos = horariosJSON[salon][dia] || [];
        let ocupado = eventos.some(ev => {
          const [hin, minin] = ev.inicio.split(':');
          const [hfin, minfin] = ev.fin.split(':');
          const evIni = parseInt(hin) * 60 + parseInt(minin);
          const evFin = parseInt(hfin) * 60 + parseInt(minfin);
          return !(finMin <= evIni || iniMin >= evFin);
        });
        if (!ocupado) libres.push(salon);
      });
      return libres;
    }

    // Cargar datos desde Google Sheets
    fetch(SHEET_URL)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(rows => {
        console.log("Datos recibidos:", rows);
        horariosJSON = agrupaHorariosPorSalon(rows);
        console.log("Horarios procesados:", horariosJSON);
        
        if (Object.keys(horariosJSON).length === 0) {
          document.getElementById('horario-espacio').innerHTML = "<b>No hay horarios cargados.</b>";
        } else {
          renderAllButtons(horariosJSON);
          // Mostrar el primer sal√≥n por defecto
          const primerSalon = ordenSalones.map(normalizaNombre).find(nombreNorm =>
            Object.keys(horariosJSON).map(normalizaNombre).includes(nombreNorm)
          );
          let nombreReal = primerSalon
            ? Object.keys(horariosJSON).find(n => normalizaNombre(n) === primerSalon)
            : Object.keys(horariosJSON)[0];
          if (nombreReal) {
            const primerBoton = document.querySelector('#button-bar button');
            if (primerBoton) {
              showSchedule(nombreReal, primerBoton);
            }
          }
        }
      })
      .catch(error => {
        console.error('Error cargando datos:', error);
        document.getElementById('horario-espacio').innerHTML = "<b>Error cargando datos.</b>";
      });

    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Buscador
      const btn = document.getElementById('buscador-btn');
      if (btn) {
        btn.onclick = function() {
          const dia = document.getElementById('busc-dia').value;
          const hora = document.getElementById('busc-hora').value;
          const dur = parseInt(document.getElementById('busc-duracion').value);

          const [h, m] = hora.split(':').map(Number);
          if (
            isNaN(h) || isNaN(m) || 
            h < 8 || h >= 20 || 
            m < 0 || m > 59
          ) {
            document.getElementById('resultado-buscador').innerHTML = `<b>‚ö†Ô∏è El horario debe estar entre 08:00 y 20:00</b>`;
            return;
          }

          const libres = buscarEspaciosLibres(dia, hora, dur);
          const resDiv = document.getElementById('resultado-buscador');
          if (libres.length) {
            resDiv.innerHTML = `<b>‚úÖ Espacios disponibles:</b><br>${libres.map(s => `<span style="display:inline-block; margin:2px 4px; padding:4px 8px; background:rgba(140,195,138,0.2); border-radius:6px; font-size:0.9rem;">${s}</span>`).join('')}`;
          } else {
            resDiv.innerHTML = `<b>‚ùå No hay espacios disponibles en ese horario</b>`;
          }
        };
      }

      // Modal
      const modalBg = document.getElementById('modal-solicitud-bg');
      if(modalBg) {
        modalBg.onclick = function(e) {
          if (e.target === this) closeSolicitud();
        };
      }
      
      // Formulario AJAX para el modal
      var form = document.getElementById("my-form");
      if(form){
        async function handleSubmit(event) {
          event.preventDefault();
          var status = document.getElementById("my-form-status");
          var data = new FormData(event.target);
          fetch(event.target.action, {
            method: form.method,
            body: data,
            headers: { 'Accept': 'application/json' }
          }).then(response => {
            if (response.ok) {
              status.innerHTML = "‚úÖ ¬°Gracias por tu solicitud!";
              status.style.color = "var(--light-green)";
              form.reset();
            } else {
              response.json().then(data => {
                if (Object.hasOwn(data, 'errors')) {
                  status.innerHTML = "‚ùå " + data["errors"].map(error => error["message"]).join(", ");
                } else {
                  status.innerHTML = "‚ùå Oops! Hubo un problema al enviar tu formulario";
                }
                status.style.color = "var(--pink-accent)";
              })
            }
          }).catch(error => {
            status.innerHTML = "‚ùå Oops! Hubo un problema al enviar tu formulario";
            status.style.color = "var(--pink-accent)";
          });
        }
        form.addEventListener("submit", handleSubmit);
      }
    });

    // Funciones del modal
    function openSolicitud() {
      document.getElementById('modal-solicitud-bg').classList.add('active');
    }

    function closeSolicitud() {
      document.getElementById('modal-solicitud-bg').classList.remove('active');
    }
  </script>
</body>
</html>
